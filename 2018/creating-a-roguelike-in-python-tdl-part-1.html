<!DOCTYPE html>
<html lang="english">
<head>
        <meta charset="utf-8" />
        <title>Creating a Roguelike in Python + TDL, Part 1: Entity-Component System</title>
        <link rel="stylesheet" href="https://nightblade9.github.io/python-zone/theme/css/main.css" />
        <link href="https://nightblade9.github.io/python-zone/atom.xml" type="application/atom+xml" rel="alternate" title="Python Zone Atom Feed" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://nightblade9.github.io/python-zone/">Python Zone </a></h1>
                <nav><ul>
                    <li><a href="https://nightblade9.github.io/python-zone/pages/about.html">About</a></li>
                    <li class="active"><a href="https://nightblade9.github.io/python-zone/category/misc.html">misc</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://nightblade9.github.io/python-zone/2018/creating-a-roguelike-in-python-tdl-part-1.html" rel="bookmark"
           title="Permalink to Creating a Roguelike in Python + TDL, Part 1: Entity-Component System">Creating a Roguelike in Python + TDL, Part 1: Entity-Component System</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-04-01T00:00:00-04:00">
                Published: Sun 01 April 2018
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://nightblade9.github.io/python-zone/author/nightblade.html">Nightblade</a>
        </address>
<p>In <a href="https://nightblade9.github.io/python-zone/category/misc.html">misc</a>.</p>

</footer><!-- /.post-info -->      <p>In this series, we're going to build a roguelike in Python and TDL. Python is a high-level, interpreted, object-oriented and functional language with expressive syntax, native lambdas, and more goodness. TDL is one of two console-like libraries for the UI (the other being <code>libtcod</code>, which is more "C++ic" than Pythonic).</p>
<p>This series aims to build on top of <a href="http://www.roguebasin.com/index.php?title=Roguelike_Tutorial,_using_python3%2Btdl">this excellent series on RogueBasin</a>, which walks you from basics to having a complete, shippable, small roguelike; the main additional benefit we want to confer from this tutorial is <em>code quality</em>.</p>
<p>The RogueBasin roguelike code, while excellent in terms of functionality, includes some poor design choices -- probably because the goal was a) make something fast that works, and b) put everything in one file so it's easy to copy-paste. As a result, it doesn't provide a solid foundation for extension -- you quickly get bogged down with complexity.</p>
<p>Specifically, we plan to:</p>
<ul>
<li>Use an entity-component system instead of a (mostly) monolithic <code>GameObject</code> base class</li>
<li>Avoid the use of global variables completely</li>
<li>Isolate TDL code as much as possible, so that our code is more testable</li>
</ul>
<p>Without further ado, let's dive into the first part: writing our entity-component system.</p>
<h1>The Simplest Entity-Component System</h1>
<p>If you haven't heard about them before, you can read <a href="http://cowboyprogramming.com/2007/01/05/evolve-your-heirachy/">this classic post about Entity-Component Systems</a>. In a nutshell, the goal is to avoid complex classes with interweaved logic (input handling + UI/drawing + game logic + ...), and instead, compose classes made of small, independent components.</p>
<p>While there are many, <em>many</em> ways to write an ECS, ours will follow the design of <a href="http://craftyjs.com">CraftyJS</a>, quite possibly one of the best ECS libraries ever:</p>
<ul>
<li>Components are small, reusable classes that encapsulate code and data (eg. <code>HealthComponent</code> with <code>get_hurt(damage)</code>, <code>die()</code>, <code>current_health</code>, etc.)</li>
<li>Entities are classes that implement custom logic that spans components</li>
</ul>
<p>With this in mind, let's create our base class: the entity.</p>
<h1>The Entity Class</h1>
<p>The Entity class has a few simple requrements:</p>
<ul>
<li>A user can <code>set(component)</code> a component, and the entity will keep that. (The entity has, at most, one component of each type/class.)</li>
<li>A user can <code>get(clazz)</code> a component, specifying the class/type, and will get the actual component</li>
<li>A user can check if an entity has a component of a specific type/class via <code>has(clazz)</code></li>
</ul>
<p>Internally, we can store components in a dictionary that maps components by type to instance.  Here's what that looks like:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Entity</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">components</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">components</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">Entity</span><span class="o">.</span><span class="n">all_entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">component</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clazz</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">clazz</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">has</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clazz</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">clazz</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
</pre></div>


<p>That's it! We don't even need a <code>Component</code> class, because entities can technically use any class/instance/object as a component.</p>
<p>We also only need a simple test: that we can <code>get</code> a component which was <code>set</code>, and that <code>has</code> returns <code>True</code> if the component exists (and <code>False</code> otherwise). We should also test that <code>set</code> overwrites the previous component. </p>
<p>Tests (<code>pytest</code> tests):</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ecs.entity</span> <span class="kn">import</span> <span class="n">Entity</span>

<span class="k">class</span> <span class="nc">TestEntity</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">test_getter_gets_set_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">Entity</span><span class="p">()</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">IntComponent</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
        <span class="n">e</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>

        <span class="n">actual</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">IntComponent</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">actual</span> <span class="o">==</span> <span class="n">expected</span>

    <span class="k">def</span> <span class="nf">test_set_overwrites_previous_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">Entity</span><span class="p">()</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">IntComponent</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>

        <span class="n">e</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">IntComponent</span><span class="p">(</span><span class="mi">1888</span><span class="p">))</span>
        <span class="n">e</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>

        <span class="n">actual</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">IntComponent</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">actual</span> <span class="o">==</span> <span class="n">expected</span>

    <span class="k">def</span> <span class="nf">test_has_retruns_true_if_component_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Note: doesn&#39;t work for subclasses of the component</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">Entity</span><span class="p">(</span><span class="n">IntComponent</span><span class="p">(</span><span class="mi">77</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">e</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">IntComponent</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">True</span>
        <span class="k">assert</span> <span class="n">e</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">StringComponent</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span>


<span class="k">class</span> <span class="nc">IntComponent</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">StringComponent</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</pre></div>


<p>With this, we can be sure our Entity class works as expected. In part two, we'll create a "Hello World" TDL application where we get the main UI window up, and start detecting/processing input so we can quit/terminate our game.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://github.com/nightblade9">Profile</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://nightblade9.github.io/python-zone/atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://twitter.com/nightblade99">Twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Copyright &copy; Nightblade, 2018+
                </address><!-- /#about -->
                
        </footer><!-- /#contentinfo -->

</body>
</html>